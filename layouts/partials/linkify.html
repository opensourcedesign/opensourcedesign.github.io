{{- $text := .text | default "" -}}
{{- $text = replace $text "\r\n" "\n" -}}
{{- $text = replace $text "\r" "\n" -}}
{{- /* Split by newlines and process each line */ -}}
{{- $lines := split $text "\n" -}}
{{- $output := slice -}}
{{- range $lines -}}
  {{- $line := trim . " " -}}
  {{- if $line -}}
    {{- /* Check if line is a URL */ -}}
    {{- if or (hasPrefix $line "http://") (hasPrefix $line "https://") -}}
      {{- $output = $output | append (printf `<a class="text-current underline decoration-current/30 underline-offset-4 hover:decoration-current break-all" href="%s" target="_blank" rel="noopener noreferrer">%s</a>` $line $line) -}}
    {{- /* Check if line contains an email in angle brackets like "Name <email@example.com>" */ -}}
    {{- else if findRE `<[^>]+@[^>]+>` $line -}}
      {{- $email := replaceRE `.*<([^>]+)>.*` "$1" $line -}}
      {{- $output = $output | append (printf `<a class="text-current underline decoration-current/30 underline-offset-4 hover:decoration-current" href="mailto:%s">%s</a>` $email $line) -}}
    {{- /* Check if line is a plain email */ -}}
    {{- else if findRE `^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}$` $line -}}
      {{- $output = $output | append (printf `<a class="text-current underline decoration-current/30 underline-offset-4 hover:decoration-current" href="mailto:%s">%s</a>` $line $line) -}}
    {{- else -}}
      {{- $output = $output | append $line -}}
    {{- end -}}
  {{- end -}}
{{- end -}}
{{- delimit $output "<br>" | safeHTML -}}
