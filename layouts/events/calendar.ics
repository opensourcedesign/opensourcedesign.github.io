{{- $events := where site.RegularPages "Section" "events" -}}
{{- $upcoming := where $events "Params.status" "in" (slice "upcoming" "started") -}}
BEGIN:VCALENDAR
VERSION:2.0
PRODID:-//Open Source Design//Events Calendar//EN
CALSCALE:GREGORIAN
METHOD:PUBLISH
X-WR-CALNAME:Open Source Design Events
X-WR-CALDESC:Meetups, online calls, conference tracks, and community gatherings from Open Source Design.
{{- range $upcoming }}
{{- $uid := printf "%s@opensourcedesign.net" .File.UniqueID }}
{{- $title := .Title | plainify }}
{{- $description := .Summary | plainify | replaceRE "\n" "\\n" }}
{{- $location := .Params.location | default "" }}
{{- $url := .Permalink }}
{{- /* Try to parse eventDate - format could vary */ -}}
{{- $eventDate := .Params.eventDate | default "" }}
BEGIN:VEVENT
UID:{{ $uid }}
DTSTAMP:{{ now.Format "20060102T150405Z" }}
{{- if $eventDate }}
{{- /* Basic date handling - assumes YYYY-MM-DD or similar */ -}}
{{- $dateParts := split (printf "%s" $eventDate) "-" }}
{{- if ge (len $dateParts) 3 }}
DTSTART;VALUE=DATE:{{ index $dateParts 0 }}{{ index $dateParts 1 }}{{ index $dateParts 2 | replaceRE "[^0-9].*" "" }}
{{- else }}
DTSTART;VALUE=DATE:{{ now.Format "20060102" }}
{{- end }}
{{- else }}
DTSTART;VALUE=DATE:{{ .Date.Format "20060102" }}
{{- end }}
SUMMARY:{{ $title }}
DESCRIPTION:{{ $description }}
{{- if $location }}
LOCATION:{{ $location }}
{{- end }}
URL:{{ $url }}
STATUS:CONFIRMED
END:VEVENT
{{- end }}
END:VCALENDAR

