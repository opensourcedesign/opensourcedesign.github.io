{{ define "main" }}
  <div class="mx-auto max-w-6xl px-4 py-12">
    {{ $jobsAll := (where (where site.RegularPages "Section" "jobs") "File.ContentBaseName" "not in" (slice "job-form" "archive")) }}
    {{ $jobs := where $jobsAll "Params.status" "in" (slice "closed" "solved" "resolved" "completed" "filled") }}
    {{ $scratch := newScratch }}
    {{ $scratch.Set "paid" 0 }}
    {{ $scratch.Set "gratis" 0 }}
    {{ range $jobs }}
      {{ $compRaw := (printf "%v" (.Params.compensation | default "")) | lower }}
      {{ if or (in $compRaw "gratis") (in $compRaw "volunteer") }}
        {{ $scratch.Add "gratis" 1 }}
      {{ else }}
        {{ $scratch.Add "paid" 1 }}
      {{ end }}
    {{ end }}
    {{ $paidCount := $scratch.Get "paid" }}
    {{ $gratisCount := $scratch.Get "gratis" }}

    <div class="rounded-2xl border border-slate-200 bg-white p-6 shadow-sm sm:p-10">
      <header class="flex flex-col gap-6 sm:flex-row sm:items-end sm:justify-between">
        <div class="max-w-2xl">
          <h1 class="text-3xl font-semibold tracking-tight text-slate-950">Job Archive</h1>
          <p class="mt-3 text-base text-slate-700">Past job listings that have been filled, closed, or completed.</p>
          <p class="mt-3 text-sm text-slate-600">
            <span class="font-semibold text-slate-900">{{ len $jobs }}</span> archived jobs
            <span class="mx-1 text-slate-300">·</span>
            <span class="font-semibold text-emerald-600">{{ $paidCount }}</span> paid
            <span class="mx-1 text-slate-300">·</span>
            <span class="font-semibold text-violet-600">{{ $gratisCount }}</span> volunteer
          </p>
        </div>
        <div class="flex flex-wrap gap-3">
          <a class="inline-flex items-center gap-2 rounded-lg border border-slate-200 bg-white px-4 py-2 text-sm font-semibold text-slate-700 hover:bg-slate-50" href="{{ "/jobs/" | relURL }}">
            <svg class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M10.5 19.5L3 12m0 0l7.5-7.5M3 12h18"/></svg>
            Back to open jobs
          </a>
          <a class="inline-flex items-center gap-2 rounded-lg bg-slate-900 px-4 py-2 text-sm font-semibold text-white shadow-sm hover:bg-slate-800" href="{{ "/jobs/job-form/" | relURL }}">
            <svg class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M12 4.5v15m7.5-7.5h-15"/></svg>
            Post a job
          </a>
        </div>
      </header>
    </div>

    {{/* Filters */}}
    <div class="mt-6 flex flex-col gap-4 sm:flex-row sm:items-center sm:justify-between">
      <div class="flex flex-wrap gap-2">
        <button class="osd-filter rounded-full px-4 py-2 text-sm font-medium" type="button" data-comp="all" aria-pressed="true">All ({{ len $jobs }})</button>
        <button class="osd-filter rounded-full px-4 py-2 text-sm font-medium" type="button" data-comp="paid" aria-pressed="false">
          <span class="inline-flex items-center gap-1.5">
            <span class="h-2 w-2 rounded-full bg-emerald-500"></span>
            Paid ({{ $paidCount }})
          </span>
        </button>
        <button class="osd-filter rounded-full px-4 py-2 text-sm font-medium" type="button" data-comp="gratis" aria-pressed="false">
          <span class="inline-flex items-center gap-1.5">
            <span class="h-2 w-2 rounded-full bg-violet-500"></span>
            Volunteer ({{ $gratisCount }})
          </span>
        </button>
      </div>
      <div class="flex gap-2">
        <label class="sr-only" for="jobs-q">Search archived jobs</label>
        <input class="w-full rounded-lg border border-slate-200 bg-white px-3 py-2 text-sm outline-none focus:border-slate-400 sm:w-72" id="jobs-q" type="search" placeholder="Search archived jobs…" autocomplete="off" />
        <button class="rounded-lg border border-slate-200 bg-white px-3 py-2 text-sm font-medium text-slate-600 hover:bg-slate-50" type="button" id="jobs-clear">Clear</button>
      </div>
    </div>

    <div class="mt-4 text-sm text-slate-500">
      <span id="jobs-count">{{ len $jobs }}</span> results
    </div>

    <p class="mt-6 hidden rounded-xl border border-slate-200 bg-white p-6 text-sm text-slate-600" id="jobs-empty">No jobs found. Try adjusting your filters.</p>

    {{/* Job Cards */}}
    <ul class="mt-6 grid grid-cols-1 gap-4 sm:grid-cols-2 lg:grid-cols-3" id="jobs-list">
      {{ range (sort $jobs "Params.date_posted" "desc") }}
        {{ $compRaw := (printf "%v" (.Params.compensation | default "")) | lower }}
        {{ $compType := cond (or (in $compRaw "gratis") (in $compRaw "volunteer")) "gratis" "paid" }}
        {{ $org := .Params.organization | default "" }}
        {{ $tags := .Params.tags | default (slice) }}
        {{ $tagsStr := "" }}
        {{ if (reflect.IsSlice $tags) }}
          {{ $tagsStr = delimit $tags "," }}
        {{ else }}
          {{ $tagsStr = printf "%v" $tags }}
        {{ end }}
        {{ $isPaid := eq $compType "paid" }}
        <li class="job-item" data-comp="{{ $compType }}" data-title="{{ .Title | plainify | lower }}" data-org="{{ $org | plainify | lower }}" data-tags="{{ $tagsStr | plainify | lower }}">
          <a class="group flex h-full flex-col rounded-2xl border border-slate-200 bg-white p-5 shadow-sm hover:border-slate-300 hover:shadow" href="{{ .RelPermalink }}">
            {{/* Header: Title + Badges */}}
            <div class="flex items-start justify-between gap-3">
              <h3 class="font-semibold leading-snug text-slate-900 group-hover:text-slate-950">{{ .Title }}</h3>
              <div class="flex shrink-0 flex-col items-end gap-1">
                {{ with .Params.status }}
                  <span class="rounded bg-slate-200 px-1.5 py-0.5 text-[10px] font-semibold uppercase text-slate-600">{{ . }}</span>
                {{ end }}
                {{ if $isPaid }}
                  <span class="inline-flex items-center gap-1 rounded-full bg-emerald-100 px-2 py-0.5 text-xs font-medium text-emerald-800">
                    <span class="h-1.5 w-1.5 rounded-full bg-emerald-500"></span>
                    Paid
                  </span>
                {{ else }}
                  <span class="inline-flex items-center gap-1 rounded-full bg-violet-100 px-2 py-0.5 text-xs font-medium text-violet-800">
                    <span class="h-1.5 w-1.5 rounded-full bg-violet-500"></span>
                    Volunteer
                  </span>
                {{ end }}
              </div>
            </div>

            {{/* Meta: Org + Date with icons */}}
            <div class="mt-3 flex flex-wrap items-center gap-x-4 gap-y-1 text-xs text-slate-500">
              {{ with $org }}
                <span class="inline-flex items-center gap-1.5">
                  <svg class="h-3.5 w-3.5 text-slate-400" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M2.25 21h19.5m-18-18v18m10.5-18v18m6-13.5V21M6.75 6.75h.75m-.75 3h.75m-.75 3h.75m3-6h.75m-.75 3h.75m-.75 3h.75M6.75 21v-3.375c0-.621.504-1.125 1.125-1.125h2.25c.621 0 1.125.504 1.125 1.125V21M3 3h12m-.75 4.5H21m-3.75 3.75h.008v.008h-.008v-.008zm0 3h.008v.008h-.008v-.008zm0 3h.008v.008h-.008v-.008z"/></svg>
                  <span class="font-medium text-slate-700">{{ . }}</span>
                </span>
              {{ end }}
              {{ with .Params.date_posted }}
                <span class="inline-flex items-center gap-1.5">
                  <svg class="h-3.5 w-3.5 text-slate-400" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M6.75 3v2.25M17.25 3v2.25M3 18.75V7.5a2.25 2.25 0 012.25-2.25h13.5A2.25 2.25 0 0121 7.5v11.25m-18 0A2.25 2.25 0 005.25 21h13.5A2.25 2.25 0 0021 18.75m-18 0v-7.5A2.25 2.25 0 015.25 9h13.5A2.25 2.25 0 0121 11.25v7.5"/></svg>
                  <span>{{ . }}</span>
                </span>
              {{ end }}
            </div>

            {{/* Summary */}}
            {{ with .Summary }}
              <p class="mt-3 flex-1 line-clamp-3 text-sm leading-relaxed text-slate-600">{{ . | plainify | truncate 150 }}</p>
            {{ end }}

            {{/* Tags */}}
            {{ if $tags }}
              <div class="mt-4 flex flex-wrap gap-1.5 border-t border-slate-100 pt-4">
                {{ if (reflect.IsSlice $tags) }}
                  {{ range first 3 $tags }}
                    <span class="rounded-full bg-slate-100 px-2 py-0.5 text-xs text-slate-600">{{ . }}</span>
                  {{ end }}
                {{ else }}
                  {{ $raw := printf "%v" $tags }}
                  {{ range first 3 (split $raw ",") }}
                    {{ $t := trim . " " }}
                    {{ if $t }}
                      <span class="rounded-full bg-slate-100 px-2 py-0.5 text-xs text-slate-600">{{ $t }}</span>
                    {{ end }}
                  {{ end }}
                {{ end }}
              </div>
            {{ end }}
          </a>
        </li>
      {{ end }}
    </ul>

    <script>
      (function () {
        var list = document.getElementById('jobs-list');
        if (!list) return;

        var items = Array.prototype.slice.call(list.querySelectorAll('.job-item'));
        var countEl = document.getElementById('jobs-count');
        var input = document.getElementById('jobs-q');
        var clearBtn = document.getElementById('jobs-clear');
        var emptyEl = document.getElementById('jobs-empty');
        var buttons = Array.prototype.slice.call(document.querySelectorAll('.osd-filter'));

        function setPressed(activeComp) {
          buttons.forEach(function (btn) {
            var on = btn.getAttribute('data-comp') === activeComp;
            btn.setAttribute('aria-pressed', on ? 'true' : 'false');
            if (on) {
              btn.classList.add('bg-slate-900', 'text-white');
              btn.classList.remove('bg-slate-100', 'text-slate-700');
            } else {
              btn.classList.remove('bg-slate-900', 'text-white');
              btn.classList.add('bg-slate-100', 'text-slate-700');
            }
          });
        }

        function getState() {
          var params = new URLSearchParams(window.location.search);
          return { comp: params.get('comp') || 'all', q: params.get('q') || '' };
        }

        function setState(next) {
          var params = new URLSearchParams(window.location.search);
          if (next.comp && next.comp !== 'all') params.set('comp', next.comp); else params.delete('comp');
          if (next.q) params.set('q', next.q); else params.delete('q');
          var qs = params.toString();
          var url = window.location.pathname + (qs ? ('?' + qs) : '');
          window.history.replaceState({}, '', url);
        }

        function apply() {
          var state = getState();
          var q = (state.q || '').trim().toLowerCase();
          setPressed(state.comp);
          if (input && input.value !== state.q) input.value = state.q;

          var shown = 0;
          items.forEach(function (li) {
            var comp = li.getAttribute('data-comp') || '';
            var hay = (li.getAttribute('data-title') || '') + ' ' + (li.getAttribute('data-org') || '') + ' ' + (li.getAttribute('data-tags') || '');
            var okComp = state.comp === 'all' || comp === state.comp;
            var okQ = !q || hay.indexOf(q) !== -1;
            var show = okComp && okQ;
            li.style.display = show ? '' : 'none';
            if (show) shown++;
          });

          if (countEl) countEl.textContent = String(shown);
          if (emptyEl) emptyEl.classList.toggle('hidden', shown !== 0);
        }

        buttons.forEach(function (btn) {
          btn.addEventListener('click', function () {
            var next = getState();
            next.comp = btn.getAttribute('data-comp') || 'all';
            setState(next);
            apply();
          });
        });

        if (input) input.addEventListener('input', function () { var next = getState(); next.q = input.value || ''; setState(next); apply(); });
        if (clearBtn && input) clearBtn.addEventListener('click', function () { var next = getState(); next.q = ''; setState(next); input.value = ''; apply(); input.focus(); });

        apply();
      })();
    </script>
  </div>
{{ end }}
